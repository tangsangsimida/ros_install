name: Test Install Script

on:
  push:
    branches: [ dev, master, github_ci_docker_test ]
  pull_request:
    branches: [ dev, master, github_ci_docker_test ]

jobs:
  generate-test-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      - name: Generate test matrix
        id: set-matrix
        run: |
          python -c "
          import yaml
          import json
          with open('tests/fish_install_test.yaml', 'r') as f:
              test_cases = yaml.safe_load(f)
          
          # 为每个测试用例创建矩阵项，包含系统版本信息
          matrix = {'include': []}
          for i, case in enumerate(test_cases):
              target_os = case.get('target_os_version', 'default')
              matrix['include'].append({
                  'test_name': case['name'],
                  'test_index': i,
                  'os_version': target_os
              })
          
          print('matrix=' + json.dumps(matrix))
          " >> $GITHUB_OUTPUT

  test-install:
    needs: generate-test-matrix
    strategy:
      matrix: 
        include: ${{ fromJSON(needs.generate-test-matrix.outputs.matrix) }}
      max-parallel: 2  # 限制同时运行的job数量
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run tests in Docker container
      run: |
        # 获取测试用例的target_os_version
        TEST_CASE=$(python3 -c "
        import yaml
        with open('tests/fish_install_test.yaml', 'r') as f:
            test_cases = yaml.safe_load(f)
        case = test_cases[${{ matrix.test_index }}]
        print(case.get('target_os_version', 'focal'))  # 默认使用focal
        ")
        echo "Using Ubuntu version: $TEST_CASE"
        
        docker run --rm \
          -v ${{ github.workspace }}:${{ github.workspace }} \
          -w ${{ github.workspace }} \
          ubuntu:$TEST_CASE \
          bash -c "
            set -u && 
            export DEBIAN_FRONTEND=noninteractive &&
            # Set timezone to avoid tzdata interactive prompt
            ln -sf /usr/share/zoneinfo/UTC /etc/localtime &&
            apt update &&
            apt install -y locales &&
            locale-gen en_US.UTF-8 &&
            export LANG=en_US.UTF-8 &&
            export LC_ALL=en_US.UTF-8 &&
            apt update && apt install -y sudo python3 python3-pip python3-venv python3-yaml python3-distro wget &&
            python3 -m venv /tmp/test_env &&
            source /tmp/test_env/bin/activate &&
            pip install --upgrade pip &&
            pip install pyyaml distro &&
            cd tests && 
            PYTHONIOENCODING=utf-8 python3 -u test_runner.py --target-os-version $TEST_CASE
          "
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ matrix.test_name }}
        path: |
          tests/test_report.json
          tests/test_report.html
        if-no-files-found: ignore